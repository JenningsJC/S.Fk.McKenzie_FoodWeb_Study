---
title: "Bootstrapping Annual Biomass Estimates by Taxa"
author: "Jeremy Jennings"
date: "11/22/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview

This is a step-by-step review of the draft R code to take raw biomass estimates from Wisseman et al., sample (with replacement) from each set of seasonal replicates, and calculate a bootstrap distribution of annual means by taxon. The code can be found at:  <https://github.com/JenningsJC/S.Fk.McKenzie_FoodWeb_Study>.

## 1. Read in dummy data: note that each combination of taxon and season's replicates has a unique, but identical, value to aid in evaluating the output of the code at each step.

```{r echo= FALSE}
dummy_benth_clean <-
  read.csv(
    "~/S.Fk.McKenzie_FoodWeb_Study/DataClean/dummy_benth_clean.csv"
  )
print(dummy_benth_clean)
```

## 2. The R function stratified()

- stratified() takes a stratified random sample from the raw dataset, as specified by the vector of columns given to it (taxon, season, biomass), of the defined size (here it is 1 value of replicate chosen randomly from the set of replicates) and outputs the associated biomasses in an array 
```{r}
library(splitstackshape)
random_sample <- stratified(dummy_benth_clean,
                              c("taxon", "season", "biomass"),
                              1 ,
                              replace = TRUE)
print(random_sample)
```
## 3. The R function tapply()
- tapply() calculates the mean of the specified column of values (biomass) in the array of biomass values that was output from the stratified() function
```{r}
means <- tapply(random_sample$biomass,
                  list(random_sample$taxon),
                  mean)
print(mean)
```
## 4. Looping the functions across the raw data frame
- placing both functions inside a "for loop" allows the user to iterate these operations "n" number of times ("for i in 1:n")

```{r}
biomass_list <- list()
means_list <- list()
for (i in 1:5) {
  random_sample <- stratified(dummy_benth_clean,
                              c("taxon", "season", "biomass"),
                              1 ,
                              replace = TRUE)
  biomass_list[[i]] <- random_sample
  
  means <- tapply(random_sample$biomass,
                  list(random_sample$taxon),
                  mean)
  means_list[[i]] <- means
}
## the below code takes the list of means output from the loop and puts
## them together into one table
annual_means <- do.call(rbind, means_list)

## the below code coerces that table into a data frame
annual_benth_means <- as.data.frame(annual_means)
```

- once assembled into a data frame, the set of annual means generated by the loop looks like the below table. Because of the values assigned in the dummy dataset, all means for caddisfly should be 6.5, for mayfly, 2.5, and stonefly 10.5:
```{r}
print(annual_benth_means)
```
- to inspect the resampled set of biomasses and double-check that the loop is working correctly and the replicate number, season and associated biomass is consistent with the dummy data:
```{r}
library(tidyr)
library(dplyr)
library(purrr)
bio_boot_samples <- biomass_list %>%
  reduce(left_join, by = c("site", "taxon", "season"))
print(bio_boot_samples)
```
